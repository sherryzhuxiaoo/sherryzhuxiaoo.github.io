<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Clock</title>
</head>

<body>
    <div class="upload-button">
        <label for="file-upload-button" class="custom-file-upload">
            Upload
        </label>
        <input id="file-upload-button" type="file" accept="image/*" onchange="handleFileUpload(event)">
    </div>
    <div class="clock">

        <div class="dot">
            <div class="dots"></div>
        </div>
        <div class="dot">
            <div class="dots"></div>
        </div>
        <div class="dot">
            <div class="dots"></div>
        </div>
        <div class="dot">
            <div class="dots"></div>
        </div>
        <div class="dot">
            <div class="dots"></div>
        </div>
        <div class="dot">
            <div class="dots"></div>
        </div>
        <div class="dot">
            <div class="dots"></div>
        </div>
        <div class="dot">
            <div class="dots"></div>
        </div>
        <div class="dot">
            <div class="dots"></div>
        </div>
        <div class="dot">
            <div class="dots"></div>
        </div>
        <div class="dot">
            <div class="dots"></div>
        </div>
        <div class="dot">
            <div class="dots"></div>
        </div>
        <div class="hour"></div>
        <div class="minute"></div>
        <div class="second"></div>
    </div>
    <script>
        var clock = document.querySelector(".clock");
        var dotAll = document.querySelectorAll(".dot");
        var hour = document.querySelector(".hour");
        var minute = document.querySelector(".minute");
        var second = document.querySelector(".second");

        let dotIndex = 0;

        let uploadArrStorage = localStorage.getItem("uploadArr")
        let uploadArr = uploadArrStorage && JSON.parse(uploadArrStorage) || []

        /** 
         * 根据base64 内容 取得 bolb 
         * 
         * @param base64String 
         * @returns Blob 
        */
        function getBlobBydataURI(base64String, type) {
            var binary = atob(base64String);
            var array = [];
            for (var i = 0; i < binary.length; i++) {
                array.push(binary.charCodeAt(i));
            }
            return new Blob([new Uint8Array(array)], { type: type });
        }

        function loadImg() {
            uploadArr.forEach(file => {
                // 读取 base64 字符串
                let base64String = file.file
                let blob = getBlobBydataURI(base64String, 'image/png')
                // 将 Blob 对象转换成 URL，然后在 img 元素中显示
                let imageUrl = URL.createObjectURL(blob);
                // 生成dom
                let parent = document.createElement('div');
                const img = document.createElement('img');
                img.src = imageUrl;
                img.style.width = '10vw';
                img.style.height = '10vw';
                parent.appendChild(img);
                clock.appendChild(parent);
                parent.classList.add("upload");
                // 设置角度
                parent.style.transform = "translate(-50%) rotate(" + file.targetRotation + "deg)";
                img.style.transform = "rotate(" + -file.targetRotation + "deg)";
            })

            handleClock()
        }

        loadImg()

        function clearOldTimestamps(arrayOfObjects) {
            let now = new Date();
            let todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            // 返回那些时间戳与当前时间差超过12小时，或者日期不是今天的对象
            const result = arrayOfObjects.filter(object => {
                let objectTime = new Date(object.timestamp);
                let timeDifference = now.getTime() - objectTime.getTime();
                let isToday = todayStart.toDateString() === objectTime.toDateString();
                return timeDifference > 12 * 60 * 60 * 1000 || !isToday;
            });

            return result;
        }

        function handleClock() {
            setInterval(() => {
                let d = new Date();
                let htime = d.getHours();
                let mtime = d.getMinutes();
                let stime = d.getSeconds();

                // console.clear()
                console.log(htime, mtime, stime);

                let uploadAllDOM = document.querySelectorAll('.upload')

                let hrotation = 30 * htime + mtime / 2;
                let mrotation = 6 * mtime;
                let srotation = 6 * stime;

                hour.style.transform = `rotate(${hrotation}deg)`;
                minute.style.transform = `rotate(${mrotation}deg)`;
                second.style.transform = `rotate(${srotation}deg)`;

                // let dotIndex = Math.floor((hrotation) / (360 / 12))
                let dotIndex = htime > 12 ? htime - 13 : htime === 0 ? 11 : htime - 1

                // console.log(dotIndex);

                // dotAll.forEach(dot => {
                //     dot.querySelector('.dots').style.backgroundColor = '#ccc'
                // })

                dotAll[dotIndex].querySelector('.dots').style.backgroundColor = 'aqua'
                dotAll[dotIndex].querySelector('.dots').innerHTML = `<img src="./${dotIndex + 1}.png" />`

                // for (let i = 0; i < uploadArr.length; i++) {
                //     console.log(isMoreThan12Hours(uploadArr[i].timestamp));
                //     if (isMoreThan12Hours(uploadArr[i].timestamp)) {
                //         console.log('超过12小时');
                //         uploadAllDOM[i].remove() // 删除页面元素
                //         uploadArr.splice(i, 1); // 从数组中删除这个对象
                //         i-- // 因为数组长度变了，所以需要重新检查当前索引
                //     }
                // }
                const res = clearOldTimestamps(uploadArr)
                // console.log(res);
                res.forEach(item => {
                    uploadAllDOM[item.index - 1].remove() // 删除页面元素
                    uploadArr.splice(item.index - 1, 1) // 从数组中删除这个对象
                })
                localStorage.setItem('uploadArr', JSON.stringify(uploadArr))
                // console.log(htime, Math.ceil(360 /( hrotation / 2)))

                // console.log((htime) * 30, (htime + 1) * 30);
                uploadArr.forEach((file, i) => {
                    if (file.targetRotation >= (htime) * 30 && file.targetRotation <= (htime + 1) * 30) {
                        // console.log('亮色');
                        // console.log();
                        uploadAllDOM[i].classList = "upload"
                    } else {
                        // console.log('暗色');
                        uploadAllDOM[i].classList = "upload gray"
                    }
                    // console.log(file.targetRotation);
                })

            }, 1000);
        }


        // 上传图片
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return; // 如果没有选择文件，则不执行任何操作

            const reader = new FileReader();

            reader.onload = function (e) {
                let base64String = e.target.result.split(',')[1]
                let parent = document.createElement('div');
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '10vw'; // 设置图片大小
                img.style.height = '10vw'; // 设置图片大小
                const currentTime = new Date();
                let currentHour = currentTime.getHours();
                let currentMinutes = currentTime.getMinutes();
                const targetRotation = 30 * currentHour + currentMinutes / 2;
                parent.appendChild(img);
                clock.appendChild(parent);
                parent.classList.add("upload");

                // 根据当前小时计算目标上传位置的索引
                parent.style.transform = "translate(-50%) rotate(" + targetRotation + "deg)";
                img.style.transform = "rotate(" + -targetRotation + "deg)";
                let targetIndex = currentHour;
                if (currentHour > 12) {
                    targetIndex -= 12;
                } else if (currentHour === 0) {
                    targetIndex = 12; // 对应于12小时位置
                }

                let now = new Date(); // 获取当前时间
                let timestamp = now.getTime(); // 获取当前时间的时间戳

                uploadArr.push({
                    file: base64String,
                    targetRotation,
                    timestamp: timestamp,
                    date: now.toISOString().split('T')[0],
                    index: uploadArr.length + 1
                })

                localStorage.setItem('uploadArr', JSON.stringify(uploadArr))

                // console.log(uploadArr);

                // 在目标上传位置添加图片元素
                // const targetUploadDiv = document.querySelectorAll('.upload')[targetIndex];
                // targetUploadDiv.innerHTML = ''; // 清除目标位置上的任何现有内容
                // targetUploadDiv.appendChild(img); // 将上传的图片附加到目标位置

                // 将图片的 base64 编码存储在本地存储中
                // localStorage.setItem(`upload-${targetIndex}`, e.target.result);
                // console.log(localStorage.getItem(`upload-${targetIndex}`, e.target.result));
            };

            reader.readAsDataURL(file);
        }






    </script>
</body>

</html>